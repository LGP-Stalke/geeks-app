<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Geeks App</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#64748b; --text:#e5e7eb; --accent:#60a5fa; --danger:#ef4444; --ok:#22c55e; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;gap:16px}
    header h1{font-size:20px;margin:0}
    nav{margin-left:auto;display:flex;gap:8px}
    button, .btn{appearance:none;border:1px solid #1f2937;background:#1f2937;color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer}
    button:hover{border-color:#334155}
    .btn-primary{background:var(--accent);border-color:var(--accent);color:#0b1220}
    .btn-danger{background:var(--danger);border-color:var(--danger)}
    .btn-ghost{background:transparent;border-color:#334155}
    .hidden{display:none!important}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;padding:20px}
    .center {display:grid;place-items:center;height:calc(100svh - 64px)}
    .form-row{display:flex;flex-direction:column;gap:8px;margin-bottom:14px}
    input{width:100%;padding:12px 14px;border:1px solid #1f2937;border-radius:10px;background:#0b1220;color:var(--text)}
    label{color:var(--muted);font-size:13px}
    .grid{display:grid;gap:12px}
    .grid-2{grid-template-columns:1fr 1fr}
    .grid-3{grid-template-columns:1fr 1fr 1fr}
    .list{display:grid;gap:8px;margin-top:12px}
    .row{display:grid;grid-template-columns:180px 220px 130px 1fr 120px 140px auto;gap:8px;align-items:center;padding:10px 12px;border:1px solid #1f2937;border-radius:10px;background:#0b1220}
    .row.header{background:#0b1220B3;border-color:#1f29374d;color:var(--muted);font-weight:600}
    .pill{padding:2px 8px;border-radius:999px;border:1px solid #1f2937;background:#0b1220;color:var(--muted);font-size:12px}
    .muted{color:var(--muted)}
    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:#0008;display:grid;place-items:center;z-index:50}
    .modal{width:min(680px,92vw)}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .topbar{display:flex;align-items:center;gap:12px;margin:12px 0}
    .grow{flex:1}
    .code{white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#0b1220;border:1px solid #1f2937;padding:10px;border-radius:10px}
    @media (max-width:980px){ .row{grid-template-columns:160px 1fr 120px;grid-auto-rows:auto} .row .hide-sm{display:none} }
  </style>
  <script>
    // Base API : priorité à window.API_URL (injectée par l'image web), sinon /api
    const BASE = (window.API_URL && window.API_URL.trim()) || '/api';

    // ---- Helpers DOM
    const el = (q) => document.querySelector(q);
    const show = (n) => n && n.classList.remove('hidden');
    const hide = (n) => n && n.classList.add('hidden');

    // ---- État global
    const state = { token:null, user:null, clients:[], editingId:null };

    // ---- Garde d'auth
    function requireAuth(){
      if(!state.token || !state.user){
        alert('Session expirée ou non connectée. Merci de vous reconnecter.');
        logout();
        return false;
      }
      return true;
    }

    // ---- Vues
    function setActiveView(name){
      ['login','clients'].forEach(v => el('#view-'+v)?.classList.add('hidden'));
      el('#view-'+name)?.classList.remove('hidden');
    }
    function showLogin(){ setActiveView('login'); }

    function onLogin(){
      el('#who').innerHTML = `Connecté: <span class="pill">${state.user.email}</span>`;
      show(el('#nav'));
      setActiveView('clients');
      loadClients();
    }
    function logout(){
      state.token = null; state.user = null; state.clients = []; state.editingId = null;
      localStorage.removeItem('token'); localStorage.removeItem('user');
      hide(el('#nav')); el('#who').textContent = '';
      el('#login_email').value=''; el('#login_pass').value='';
      setActiveView('login');
      // Fermer modale si restée ouverte
      hide(el('#modalBackdrop'));
    }

    // ---- Auth
    async function login(ev){
      ev?.preventDefault();
      const email = el('#login_email').value.trim();
      const password = el('#login_pass').value;
      if(!email || !password){ alert('Email et mot de passe requis'); return; }
      try{
        const r = await fetch(`${BASE}/login`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ email, password })
        });
        const data = await r.json();
        if(!r.ok){ el('#login_result').textContent = JSON.stringify(data,null,2); return; }
        state.token = data.token;
        state.user  = data.user;
        localStorage.setItem('token', state.token);
        localStorage.setItem('user', JSON.stringify(state.user));
        el('#login_result').textContent = '';
        onLogin();
      }catch(e){
        el('#login_result').textContent = e.message;
        console.error(e);
      }
    }

    // ---- Clients
    async function loadClients(){
      if(!requireAuth()) return;
      try{
        const r = await fetch(`${BASE}/clients`, {
          headers:{ Authorization:'Bearer '+state.token }
        });
        const data = await r.json();
        state.clients = Array.isArray(data)? data : [];
        renderClients();
      }catch(e){
        console.error(e);
        el('#clients_list').innerHTML = `<div class="code">Erreur: ${e.message}</div>`;
      }
    }

    function renderClients(){
      const list = el('#clients_list');
      if(!state.clients.length){
        list.innerHTML = `<div class="code muted">Aucun client pour le moment.</div>`;
        return;
      }
      let html = `
        <div class="row header">
          <div>Nom</div>
          <div>Email</div>
          <div class="hide-sm">Téléphone</div>
          <div class="hide-sm">Adresse</div>
          <div class="hide-sm">CP</div>
          <div class="hide-sm">Ville</div>
          <div>Actions</div>
        </div>
      `;
      for(const c of state.clients){
        html += `
          <div class="row">
            <div>${escapeHtml(c.name||'')}</div>
            <div>${escapeHtml(c.email||'')}</div>
            <div class="hide-sm">${escapeHtml(c.phone||'')}</div>
            <div class="hide-sm">${escapeHtml(c.address||'')}</div>
            <div class="hide-sm">${escapeHtml(c.zip||'')}</div>
            <div class="hide-sm">${escapeHtml(c.city||'')}</div>
            <div style="display:flex;gap:6px">
              <button class="btn-ghost" onclick="openEdit(${c.id})">Éditer</button>
              <button class="btn-danger" onclick="delClient(${c.id})">Supprimer</button>
            </div>
          </div>
        `;
      }
      list.innerHTML = html;
    }

    // ---- Modale
    function openAdd(){
      if(!requireAuth()) return;
      state.editingId = null;
      el('#modalTitle').textContent = 'Nouveau client';
      el('#f_name').value=''; el('#f_email').value='';
      el('#f_phone').value=''; el('#f_address').value='';
      el('#f_zip').value=''; el('#f_city').value='';
      show(el('#modalBackdrop'));
    }
    function openEdit(id){
      if(!requireAuth()) return;
      const c = state.clients.find(x=>x.id===id);
      if(!c) return;
      state.editingId = id;
      el('#modalTitle').textContent = 'Modifier client';
      el('#f_name').value=c.name||'';
      el('#f_email').value=c.email||'';
      el('#f_phone').value=c.phone||'';
      el('#f_address').value=c.address||'';
      el('#f_zip').value=c.zip||'';
      el('#f_city').value=c.city||'';
      show(el('#modalBackdrop'));
    }
    function closeModal(){ hide(el('#modalBackdrop')); }

    async function saveClient(){
      if(!requireAuth()) return;
      const payload = {
        name: el('#f_name').value.trim(),
        email: valOrNull('#f_email'),
        phone: valOrNull('#f_phone'),
        address: valOrNull('#f_address'),
        zip: valOrNull('#f_zip'),
        city: valOrNull('#f_city'),
      };
      if(!payload.name){ alert('Le nom est obligatoire'); return; }

      const isEdit = !!state.editingId;
      const url    = isEdit ? `${BASE}/clients/${state.editingId}` : `${BASE}/clients`;
      const method = isEdit ? 'PUT' : 'POST';

      const r = await fetch(url, {
        method, headers:{'Content-Type':'application/json', Authorization:'Bearer '+state.token},
        body: JSON.stringify(payload)
      });
      if(!r.ok){ alert('Erreur API: '+await r.text()); return; }
      closeModal();
      await loadClients();
    }

    async function delClient(id){
      if(!requireAuth()) return;
      if(!confirm('Supprimer ce client ?')) return;
      const r = await fetch(`${BASE}/clients/${id}`, {
        method:'DELETE', headers:{ Authorization:'Bearer '+state.token }
      });
      if(!r.ok){ alert('Erreur API: '+await r.text()); return; }
      await loadClients();
    }

    // ---- Utils
    function valOrNull(sel){ const v = el(sel).value.trim(); return v ? v : null; }
    function escapeHtml(s){ return String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    // ---- Boot
    document.addEventListener('DOMContentLoaded', () => {
      // cacher modale au démarrage
      hide(el('#modalBackdrop'));

      // restaurer session
      try{
        state.token = localStorage.getItem('token') || null;
        state.user  = JSON.parse(localStorage.getItem('user') || 'null');
      }catch{ state.token=null; state.user=null; }

      if(state.token && state.user) onLogin();
      else { hide(el('#nav')); showLogin(); }

      // actions
      el('#login_form')?.addEventListener('submit', login);
      el('#btnAdd')?.addEventListener('click', openAdd);
      el('#btnSave')?.addEventListener('click', saveClient);
      el('#btnCancel')?.addEventListener('click', closeModal);
      el('#logout')?.addEventListener('click', logout);
      el('#refresh')?.addEventListener('click', loadClients);
    });
  </script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Geeks App</h1>
      <div id="who" class="muted"></div>
      <nav id="nav" class="hidden">
        <button id="refresh" title="Rafraîchir">Rafraîchir</button>
        <button id="btnAdd" class="btn-primary">Ajouter</button>
        <button id="logout" class="btn-ghost">Déconnexion</button>
      </nav>
    </header>

    <!-- Vue Login -->
    <section id="view-login" class="center">
      <form id="login_form" class="card" style="width:min(520px,92vw)">
        <h2 style="margin:4px 0 14px 0">Connexion</h2>
        <div class="form-row">
          <label for="login_email">Email</label>
          <input id="login_email" type="email" placeholder="admin@geeksdupc.fr" autocomplete="username"/>
        </div>
        <div class="form-row">
          <label for="login_pass">Mot de passe</label>
          <input id="login_pass" type="password" placeholder="••••••••" autocomplete="current-password"/>
        </div>
        <div class="actions">
          <button type="submit" class="btn-primary">Se connecter</button>
        </div>
        <pre id="login_result" class="code muted" style="margin-top:12px"></pre>
      </form>
    </section>

    <!-- Vue Clients -->
    <section id="view-clients" class="hidden">
      <div class="topbar">
        <div class="muted">Gestion des clients</div>
        <div class="grow"></div>
        <button id="refresh">Rafraîchir</button>
        <button id="btnAdd" class="btn-primary">Ajouter</button>
      </div>
      <div id="clients_list" class="list"></div>
    </section>
  </div>

  <!-- Modale Ajouter/Éditer -->
  <div id="modalBackdrop" class="modal-backdrop hidden" onclick="if(event.target===this) closeModal()">
    <div class="modal card">
      <h3 id="modalTitle" style="margin-top:0;margin-bottom:14px">Nouveau client</h3>
      <div class="grid">
        <div class="form-row">
          <label>Nom *</label>
          <input id="f_name" placeholder="Nom de la société / client" />
        </div>
        <div class="form-row">
          <label>Email</label>
          <input id="f_email" type="email" placeholder="contact@exemple.fr"/>
        </div>
        <div class="form-row">
          <label>Téléphone</label>
          <input id="f_phone" placeholder="06 00 00 00 00"/>
        </div>
        <div class="form-row">
          <label>Adresse</label>
          <input id="f_address" placeholder="12 rue des Lilas"/>
        </div>
        <div class="grid grid-2" style="gap:12px">
          <div class="form-row">
            <label>CP</label>
            <input id="f_zip" placeholder="75002"/>
          </div>
          <div class="form-row">
            <label>Ville</label>
            <input id="f_city" placeholder="Paris"/>
          </div>
        </div>
      </div>
      <div class="actions">
        <button id="btnSave" class="btn-primary">Enregistrer</button>
        <button id="btnCancel" class="btn-ghost">Annuler</button>
      </div>
    </div>
  </div>
</body>
</html>
