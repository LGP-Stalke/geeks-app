<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Geeks App</title>
  <style>
    :root{
      --bg:#0f1218;--panel:#171c24;--panel-2:#1e2430;--txt:#e8edf7;--muted:#93a1b3;
      --pri:#4da3ff;--pri-2:#2b7bd6;--danger:#ff5d5d;--ok:#39d98a;--warn:#f5c15c;
      --border:#283141;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--txt);font:14px/1.4 system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    h1{margin:0 0 16px}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid-col-span-2{grid-column:1/-1}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:10px;margin:16px 0}
    .card-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border)}
    .card-body{padding:12px 14px}
    .actions{display:flex;gap:8px}
    .row{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border:1px solid var(--border);border-radius:8px;background:var(--panel-2);margin:8px 0}
    .row-main{display:flex;flex-direction:column;gap:4px}
    .row-actions{display:flex;gap:8px}
    .form-group{display:flex;flex-direction:column;gap:6px}
    input,select,textarea{width:100%;background:#0b0f15;border:1px solid var(--border);color:var(--txt);border-radius:8px;padding:10px 12px;outline:none}
    textarea{resize:vertical}
    .btn{background:var(--pri);color:#fff;border:none;border-radius:8px;padding:10px 14px;cursor:pointer}
    .btn:hover{background:var(--pri-2)}
    .btn-ghost{background:transparent;border:1px solid var(--border);color:var(--txt)}
    .btn-danger{background:var(--danger);color:#fff;border:none}
    .btn.primary{background:var(--pri)}
    .login-card{max-width:520px;margin:48px auto;background:var(--panel);border:1px solid var(--border);border-radius:12px}
    .login-card .card-body{display:flex;flex-direction:column;gap:12px}
    /* modal */
    .modal{display:none;position:fixed;inset:0;background:#00000088;align-items:center;justify-content:center;padding:18px;z-index:999}
    .modal-card{width:min(880px, 96vw);background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:0 10px 30px #0007}
    .modal-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--border)}
    .modal-body{padding:12px 14px}
    .modal-footer{padding:12px 14px;display:flex;gap:8px;justify-content:flex-end;border-top:1px solid var(--border)}
    .modal-close{background:transparent;border:1px solid var(--border);color:var(--txt);border-radius:8px;padding:0 8px;height:32px;cursor:pointer}
    .badge{display:inline-block;padding:3px 8px;border-radius:999px;background:#243045;border:1px solid var(--border);color:var(--txt)}
    .status-NEW{background:#293243}
    .status-PLANNED{background:#30424f}
    .status-DONE{background:#1f3c30}
    .status-CANCELLED{background:#3b2b2b}
    .topbar{display:flex;align-items:center;gap:18px;margin-bottom:8px}
    .link{color:var(--pri);text-decoration:none}
    .link:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1>Geeks App</h1>
      <div class="muted small" id="who"></div>
      <div style="flex:1"></div>
      <a href="#" id="btnLogout" class="link">Se déconnecter</a>
    </div>

    <!-- Connexion -->
    <section id="secLogin" class="login-card">
      <div class="card-header"><h2>Connexion</h2></div>
      <div class="card-body">
        <div class="form-group">
          <label>Email</label>
          <input id="login_email" type="email" value="admin@geeksdupc.fr"/>
        </div>
        <div class="form-group">
          <label>Mot de passe</label>
          <input id="login_pass" type="password"/>
        </div>
        <button class="btn" id="btnLogin">Se connecter</button>
      </div>
    </section>

    <!-- App -->
    <section id="secApp" style="display:none">

      <!-- Clients -->
      <section class="card">
        <div class="card-header">
          <h2>Clients</h2>
          <div class="actions">
            <button class="btn" id="btnNewClient">Nouveau client</button>
            <button class="btn" id="btnReloadClients">Rafraîchir</button>
          </div>
        </div>
        <div class="card-body">
          <div id="clients_list"></div>
        </div>
      </section>

      <!-- Interventions -->
      <section class="card">
        <div class="card-header">
          <h2>Interventions</h2>
          <div class="actions">
            <button class="btn" id="btnNewInterv">Nouvelle intervention</button>
            <button class="btn" id="btnReloadInterv">Rafraîchir</button>
          </div>
        </div>
        <div class="card-body">
          <div id="interv_list"></div>
        </div>
      </section>

    </section>
  </div>

  <!-- Modal Client -->
  <div class="modal" id="modalClient">
    <div class="modal-card">
      <div class="modal-header">
        <h3 id="clientModalTitle">Nouveau client</h3>
        <button class="modal-close" data-close="#modalClient">&times;</button>
      </div>
      <div class="modal-body grid-2">
        <div class="form-group grid-col-span-2">
          <label>Nom *</label>
          <input id="c_name" type="text" />
        </div>
        <div class="form-group">
          <label>Email</label>
          <input id="c_email" type="email" />
        </div>
        <div class="form-group">
          <label>Téléphone</label>
          <input id="c_phone" />
        </div>
        <div class="form-group grid-col-span-2">
          <label>Adresse</label>
          <input id="c_address" />
        </div>
        <div class="form-group">
          <label>CP</label>
          <input id="c_zip" />
        </div>
        <div class="form-group">
          <label>Ville</label>
          <input id="c_city" />
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn primary" id="btnSaveClient">Enregistrer</button>
        <button class="btn-ghost" data-close="#modalClient">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Modal Intervention -->
  <div class="modal" id="modalInterv">
    <div class="modal-card">
      <div class="modal-header">
        <h3 id="intervModalTitle">Nouvelle intervention</h3>
        <button class="modal-close" data-close="#modalInterv">&times;</button>
      </div>
      <div class="modal-body grid-2">
        <div class="form-group">
          <label>Client *</label>
          <select id="i_client"></select>
        </div>
        <div class="form-group">
          <label>Titre *</label>
          <input id="i_title" type="text" />
        </div>
        <div class="form-group grid-col-span-2">
          <label>Description</label>
          <textarea id="i_desc" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label>Statut</label>
          <select id="i_status">
            <option value="">(auto)</option>
            <option>NEW</option>
            <option>PLANNED</option>
            <option>DONE</option>
            <option>CANCELLED</option>
          </select>
        </div>
        <div class="form-group">
          <label>Technicien (id)</label>
          <input id="i_tech" type="number" min="1"/>
        </div>
        <div class="form-group">
          <label>Début</label>
          <input id="i_start" type="datetime-local"/>
        </div>
        <div class="form-group">
          <label>Fin</label>
          <input id="i_end" type="datetime-local"/>
        </div>
        <div class="form-group grid-col-span-2">
          <label>Adresse</label>
          <input id="i_address" type="text"/>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn primary" id="btnSaveInterv">Enregistrer</button>
        <button class="btn-ghost" data-close="#modalInterv">Annuler</button>
      </div>
    </div>
  </div>

  <script>
    // --------- Config API ---------
    // 1) Si window.API_URL est défini (injection nginx), on l'utilise
    // 2) Sinon on essaie de deviner : si tu ouvres http://NAS:8080 => API http://NAS:3200
    const BASE = (window.API_URL && window.API_URL.replace(/\/$/,'')) || (() => {
      const u=new URL(location.href);
      if(u.port==='8080'||u.port===''||u.port==='80'){ u.port='3200'; }
      // sinon, laisse tel quel (utile si tu ouvres l'API directe en 3000/3200)
      u.hash=''; u.search=''; u.pathname='';
      return u.origin;
    })();

    // --------- State / helpers ---------
    const state = {
      token: localStorage.getItem('geeks_token') || null,
      user:  JSON.parse(localStorage.getItem('geeks_user')||'null'),
      editingClientId: null,
      editingIntervId: null
    };
    function el(q){ return document.querySelector(q); }
    function show(q){ el(q).style.display='flex'; }
    function hide(q){ el(q).style.display='none'; }
    function escapeHtml(s){ return (s??'').toString().replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
    function toIso(v){ if(!v) return undefined; return new Date(v).toISOString(); }
    function setAuthUI(){
      if(state.token){ el('#secLogin').style.display='none'; el('#secApp').style.display='block'; el('#who').textContent = `Connecté: ${state.user?.email||''}`; }
      else{ el('#secLogin').style.display='block'; el('#secApp').style.display='none'; el('#who').textContent=''; }
    }
    function requireAuth(){ if(!state.token){ alert('Veuillez vous connecter.'); return false; } return true; }

    // --------- Login / Logout ---------
    async function doLogin(){
      const email = el('#login_email').value.trim();
      const password = el('#login_pass').value;
      const r = await fetch(`${BASE}/login`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({email,password})
      });
      const txt = await r.text().catch(()=> '');
      if(!r.ok){ console.error('login error', r.status, txt); alert('Mauvais identifiants'); return; }
      const data = JSON.parse(txt);
      state.token = data.token; state.user = data.user;
      localStorage.setItem('geeks_token', state.token);
      localStorage.setItem('geeks_user', JSON.stringify(state.user||null));
      setAuthUI();
      await Promise.all([loadClients(), loadInterventions()]);
    }
    function doLogout(){
      state.token=null; state.user=null;
      localStorage.removeItem('geeks_token'); localStorage.removeItem('geeks_user');
      setAuthUI();
    }

    // --------- Clients ----------
    async function loadClients(){
      if(!requireAuth()) return;
      const r = await fetch(`${BASE}/clients`, { headers:{Authorization:'Bearer '+state.token} });
      const txt = await r.text().catch(()=> '');
      if(!r.ok){ console.error('loadClients', r.status, txt); el('#clients_list').innerHTML='<div class="muted">Erreur chargement clients</div>'; return; }
      const list = JSON.parse(txt);
      renderClients(list);
    }
    function renderClients(list){
      if(!Array.isArray(list) || list.length===0){
        el('#clients_list').innerHTML='<div class="muted">Aucun client</div>'; return;
      }
      el('#clients_list').innerHTML = list.map(c=>`
        <div class="row">
          <div class="row-main">
            <div><b>${escapeHtml(c.name||'(sans nom)')}</b></div>
            <div class="muted small">${escapeHtml(c.email||'')} ${c.phone?`• ${escapeHtml(c.phone)}`:''}</div>
            <div class="muted small">${escapeHtml(c.address||'')} ${escapeHtml(c.zip||'')} ${escapeHtml(c.city||'')}</div>
          </div>
          <div class="row-actions">
            <button class="btn-ghost js-edit" data-id="${c.id}">Éditer</button>
            <button class="btn-danger js-del" data-id="${c.id}">Suppr</button>
          </div>
        </div>
      `).join('');
    }
    async function openClientNew(){
      if(!requireAuth()) return;
      state.editingClientId=null;
      el('#clientModalTitle').textContent='Nouveau client';
      el('#c_name').value=''; el('#c_email').value=''; el('#c_phone').value='';
      el('#c_address').value=''; el('#c_zip').value=''; el('#c_city').value='';
      show('#modalClient');
    }
    async function openClientEdit(id){
      if(!requireAuth()) return;
      state.editingClientId=id;
      el('#clientModalTitle').textContent=`Éditer client #${id}`;
      const r = await fetch(`${BASE}/clients/${id}`, { headers:{Authorization:'Bearer '+state.token} });
      const txt = await r.text().catch(()=> '');
      if(!r.ok){ console.error('openClientEdit', r.status, txt); alert('Impossible de charger le client'); return; }
      const c = JSON.parse(txt);
      el('#c_name').value=c.name||''; el('#c_email').value=c.email||''; el('#c_phone').value=c.phone||'';
      el('#c_address').value=c.address||''; el('#c_zip').value=c.zip||''; el('#c_city').value=c.city||'';
      show('#modalClient');
    }
    async function saveClient(){
      if(!requireAuth()) return;
      const name = el('#c_name').value.trim();
      const email= el('#c_email').value.trim();
      const phone= el('#c_phone').value.trim();
      const addr = el('#c_address').value.trim();
      const zip  = el('#c_zip').value.trim();
      const city = el('#c_city').value.trim();
      if(!name){ alert('Nom obligatoire'); return; }

      const payload={ name };
      if(email) payload.email=email;
      if(phone) payload.phone=phone;
      if(addr)  payload.address=addr;
      if(zip)   payload.zip=zip;
      if(city)  payload.city=city;

      const isEdit=!!state.editingClientId;
      const url = isEdit? `${BASE}/clients/${state.editingClientId}` : `${BASE}/clients`;
      const method = isEdit? 'PUT':'POST';
      if(isEdit) payload.id=state.editingClientId;

      const r = await fetch(url, {
        method, headers:{'Content-Type':'application/json', Authorization:'Bearer '+state.token},
        body:JSON.stringify(payload)
      });
      const txt = await r.text().catch(()=> '');
      if(!r.ok){ console.error('saveClient', r.status, txt, payload); alert('Erreur API: '+(txt||r.status)); return; }
      hide('#modalClient'); await loadClients();
    }
    async function delClient(id){
      if(!requireAuth()) return;
      if(!confirm('Supprimer ce client ?')) return;
      const r = await fetch(`${BASE}/clients/${id}`, { method:'DELETE', headers:{Authorization:'Bearer '+state.token} });
      const txt = await r.text().catch(()=> '');
      if(!r.ok){ console.error('delClient', r.status, txt); alert('Suppression impossible'); return; }
      await loadClients();
    }

    // --------- Interventions ----------
    async function fillClientSelect(){
      const sel=el('#i_client'); sel.innerHTML='<option value="">(choisir)</option>';
      const r = await fetch(`${BASE}/clients`, { headers:{Authorization:'Bearer '+state.token} });
      if(!r.ok) return;
      const list = await r.json();
      sel.innerHTML += list.map(c=>`<option value="${c.id}">${escapeHtml(c.name)} (#${c.id})</option>`).join('');
    }
    async function loadInterventions(){
      if(!requireAuth()) return;
      const r = await fetch(`${BASE}/interventions`, { headers:{Authorization:'Bearer '+state.token} });
      const txt = await r.text().catch(()=> '');
      if(!r.ok){ console.error('loadInterventions', r.status, txt); el('#interv_list').innerHTML='<div class="muted">Erreur chargement interventions</div>'; return; }
      const list = JSON.parse(txt);
      renderInterventions(list);
    }
    function renderInterventions(list){
      if(!Array.isArray(list) || list.length===0){
        el('#interv_list').innerHTML='<div class="muted">Aucune intervention</div>'; return;
      }
      el('#interv_list').innerHTML = list.map(it=>`
        <div class="row">
          <div class="row-main">
            <div>
              <b>${escapeHtml(it.title||'(sans titre)')}</b>
              ${it.status?`<span class="badge status-${escapeHtml(it.status)}">${escapeHtml(it.status)}</span>`:''}
            </div>
            <div class="muted small">Client #${it.client_id} • ${it.starts_at||''} → ${it.ends_at||''}</div>
            ${it.address?`<div class="muted small">${escapeHtml(it.address)}</div>`:''}
          </div>
          <div class="row-actions">
            <button class="btn-ghost js-edit-interv" data-id="${it.id}">Éditer</button>
            <button class="btn-danger js-del-interv" data-id="${it.id}">Suppr</button>
          </div>
        </div>
      `).join('');
    }
    async function openIntervNew(){
      if(!requireAuth()) return;
      state.editingIntervId=null;
      el('#intervModalTitle').textContent='Nouvelle intervention';
      await fillClientSelect();
      el('#i_client').value=''; el('#i_title').value=''; el('#i_desc').value='';
      el('#i_status').value=''; el('#i_tech').value='';
      el('#i_start').value=''; el('#i_end').value=''; el('#i_address').value='';
      show('#modalInterv');
    }
    async function openIntervEdit(id){
      if(!requireAuth()) return;
      state.editingIntervId=id;
      el('#intervModalTitle').textContent=`Éditer intervention #${id}`;
      await fillClientSelect();
      const r = await fetch(`${BASE}/interventions/${id}`, { headers:{Authorization:'Bearer '+state.token} });
      const txt = await r.text().catch(()=> '');
      if(!r.ok){ console.error('openIntervEdit', r.status, txt); alert('Impossible de charger l’intervention'); return; }
      const it = JSON.parse(txt);
      el('#i_client').value=it.client_id??'';
      el('#i_title').value =it.title??'';
      el('#i_desc').value  =it.description??'';
      el('#i_status').value=it.status??'';
      el('#i_tech').value  =it.tech_id??'';
      el('#i_start').value =it.starts_at? new Date(it.starts_at).toISOString().slice(0,16):'';
      el('#i_end').value   =it.ends_at?   new Date(it.ends_at).toISOString().slice(0,16):'';
      el('#i_address').value=it.address??'';
      show('#modalInterv');
    }
    async function saveIntervention(){
      if(!requireAuth()) return;
      const client_id= +el('#i_client').value || null;
      const title    = el('#i_title').value.trim();
      if(!client_id){ alert('Client obligatoire'); return; }
      if(!title){ alert('Titre obligatoire'); return; }

      const payload={ client_id, title };
      const desc = el('#i_desc').value.trim(); if(desc) payload.description=desc;
      const status = el('#i_status').value.trim(); if(status) payload.status=status;
      const tech = el('#i_tech').value.trim(); if(tech) payload.tech_id=+tech;
      const s = el('#i_start').value; if(s) payload.starts_at=toIso(s);
      const e = el('#i_end').value;   if(e) payload.ends_at=toIso(e);
      const addr= el('#i_address').value.trim(); if(addr) payload.address=addr;

      const isEdit=!!state.editingIntervId;
      const url = isEdit? `${BASE}/interventions/${state.editingIntervId}` : `${BASE}/interventions`;
      const method = isEdit? 'PUT':'POST';
      if(isEdit) payload.id=state.editingIntervId;

      const r = await fetch(url, {
        method, headers:{'Content-Type':'application/json', Authorization:'Bearer '+state.token},
        body:JSON.stringify(payload)
      });
      const txt = await r.text().catch(()=> '');
      if(!r.ok){ console.error('saveIntervention', r.status, txt, payload); alert('Erreur API: '+(txt||r.status)); return; }
      hide('#modalInterv'); await loadInterventions();
    }
    async function delIntervention(id){
      if(!requireAuth()) return;
      if(!confirm('Supprimer cette intervention ?')) return;
      const r = await fetch(`${BASE}/interventions/${id}`, { method:'DELETE', headers:{Authorization:'Bearer '+state.token} });
      const txt = await r.text().catch(()=> '');
      if(!r.ok){ console.error('delIntervention', r.status, txt); alert('Suppression impossible'); return; }
      await loadInterventions();
    }

    // --------- Events ----------
    document.addEventListener('click', (e)=>{
      const target = e.target;
      const sel = target?.dataset?.close;
      if(sel){ hide(sel); }

      // Clients
      if(target.id==='btnNewClient') openClientNew();
      if(target.id==='btnReloadClients') loadClients();
      if(target.id==='btnSaveClient') saveClient();

      // Interventions
      if(target.id==='btnNewInterv') openIntervNew();
      if(target.id==='btnReloadInterv') loadInterventions();
      if(target.id==='btnSaveInterv') saveIntervention();

      if(target.id==='btnLogin') doLogin();
      if(target.id==='btnLogout'){ e.preventDefault(); doLogout(); }
    });

    // Délégation sur les listes
    el('#clients_list')?.addEventListener('click', (e)=>{
      const id = e.target?.dataset?.id; if(!id) return;
      if(e.target.classList.contains('js-edit')) openClientEdit(+id);
      if(e.target.classList.contains('js-del'))  delClient(+id);
    });
    el('#interv_list')?.addEventListener('click', (e)=>{
      const id = e.target?.dataset?.id; if(!id) return;
      if(e.target.classList.contains('js-edit-interv')) openIntervEdit(+id);
      if(e.target.classList.contains('js-del-interv'))  delIntervention(+id);
    });

    // --------- Init ---------
    setAuthUI();
    if(state.token){
      // pré-chargement
      Promise.all([loadClients(), loadInterventions()]).catch(()=>{});
    }
  </script>
</body>
</html>
